<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Classweb 4/10 - Class Blog</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap');

    :root {
      --primary: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      --primary-solid: #3b82f6;
      --primary-bright: #60a5fa;
      --secondary: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
      --accent: linear-gradient(135deg, #10b981 0%, #06b6d4 100%);
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --blog: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
      
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --bg-card: #ffffff;
      --bg-glass: rgba(255, 255, 255, 0.9);
      
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      
      --border: #e2e8f0;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
      
      --radius: 12px;
      --radius-lg: 16px;
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
      -webkit-touch-callout: none;
      -webkit-text-size-adjust: none;
    }

    /* Header */
    .header {
      position: relative;
      height: 70vh;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      background: linear-gradient(135deg, rgba(240, 249, 255, 0.9) 0%, rgba(224, 231, 255, 0.6) 100%);
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('classpic.jpg') center/cover no-repeat;
      opacity: 0.2;
      z-index: 1;
    }

    .header-content {
      position: relative;
      z-index: 2;
    }

    .header h1 {
      font-family: 'Poppins', sans-serif;
      font-size: clamp(2.5rem, 6vw, 4rem);
      font-weight: 700;
      background: var(--blog);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 1rem;
    }

    .header p {
      font-size: clamp(1rem, 2.5vw, 1.3rem);
      color: var(--text-secondary);
      margin-bottom: 2rem;
      font-weight: 400;
    }

    /* Main Content */
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 1.5rem;
    }

    .section {
      padding: 3rem 0;
    }

    /* Blog Post Styles */
    .blog-post {
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .blog-post:hover {
      box-shadow: var(--shadow-hover);
    }

    .blog-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1.5rem;
    }

    .blog-title {
      font-family: 'Poppins', sans-serif;
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .blog-author {
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .blog-date {
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .blog-content {
      margin-bottom: 1.5rem;
      color: var(--text-secondary);
      line-height: 1.7;
    }

    .blog-media {
      margin: 1.5rem 0;
      border-radius: var(--radius);
      overflow: hidden;
    }

    .blog-media img, .blog-media video {
      width: 100%;
      border-radius: var(--radius);
      max-height: 500px;
      object-fit: contain;
    }

    .blog-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .like-btn, .comment-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      transition: var(--transition);
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      font-size: 1rem;
    }

    /* Add hover and active states */
    .like-btn:hover, .comment-btn:hover {
      background: rgba(59, 130, 246, 0.1);
      color: var(--primary-solid);
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
    }

    .like-btn:active, .comment-btn:active {
      transform: scale(0.95);
    }

    .like-btn.liked {
      color: var(--danger);
      background: rgba(239, 68, 68, 0.1);
    }

    .comments-section {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
      display: none;
    }

    .comments-section.expanded {
      display: block;
    }

    .comment {
      margin-bottom: 1rem;
      padding: 1rem;
      background: var(--bg-secondary);
      border-radius: var(--radius);
    }

    .comment-author {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }

    .comment-date {
      color: var(--text-muted);
      font-size: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .comment-content {
      color: var(--text-secondary);
    }

    .add-comment {
      margin-top: 1.5rem;
      display: flex;
      gap: 0.5rem;
    }

    .comment-input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: inherit;
      resize: none;
      min-height: 50px;
    }

    .comment-submit {
      padding: 0 1.5rem;
      background: var(--primary-solid);
      color: white;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      transition: var(--transition);
    }

    .comment-submit:hover {
      background: var(--primary-bright);
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 500px;
      padding: 1.5rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      position: relative;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
    }

    .modal-title {
      font-family: 'Poppins', sans-serif;
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: var(--text-primary);
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
      font-weight: 500;
    }

    .form-input, .form-textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: inherit;
      background: var(--bg-secondary);
    }

    .form-textarea {
      min-height: 100px;
      max-height: 200px;
      resize: vertical;
    }

    .file-upload {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      margin-bottom: 1.5rem;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
    }

    .file-upload:hover {
      border-color: var(--primary-bright);
    }

    .file-upload i {
      font-size: 2rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    #mediaUpload {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      opacity: 0;
      cursor: pointer;
    }

    .file-preview {
      margin-top: 1rem;
      display: none;
    }

    .file-preview img, .file-preview video {
      max-width: 100%;
      max-height: 200px;
      border-radius: var(--radius);
    }

    .remove-file {
      margin-top: 0.5rem;
      color: var(--danger);
      cursor: pointer;
      font-size: 0.85rem;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    /* Button styles */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--radius);
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
      font-size: 0.9rem;
    }

    .btn-primary {
      background: var(--primary-solid);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-bright);
      transform: translateY(-1px);
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
    }

    .btn-outline {
      background: transparent;
      color: var(--primary-solid);
      border: 1px solid var(--primary-solid);
    }

    .btn-outline:hover {
      background: var(--primary-solid);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    /* Search and Filter */
    .search-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 2rem;
    }

    .search-input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: inherit;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary-bright);
    }

    /* File upload options */
    .file-options {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      justify-content: center;
      width: 100%;
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
    }

    /* Upload preview styles */
    .upload-preview {
      position: relative;
      margin-top: 1rem;
      display: inline-block;
      width: 100%;
      max-height: 200px;
      border-radius: var(--radius);
      overflow: hidden;
    }

    .upload-preview img, .upload-preview video {
      width: 100%;
      height: auto;
      border-radius: var(--radius);
    }

    .loading-spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top: 4px solid var(--primary-solid);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    .uploading::after {
      content: "Uploading...";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 0 1rem;
      }
      
      .section {
        padding: 2rem 0;
      }
      
      .blog-header {
        flex-direction: column;
      }
      
      .blog-date {
        margin-top: 0.5rem;
      }
      
      .modal-content {
        width: 95%;
        padding: 1rem;
        margin: 1rem;
        max-height: 90vh;
      }
      
      .add-comment {
        flex-direction: column;
      }

      .file-options {
        flex-direction: column;
      }
    }
  </style>
  <!-- Font Awesome CDN -->
  <script src="https://kit.fontawesome.com/9f295c42cb.js" crossorigin="anonymous"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
</head>
<body>
  <!-- Header Section -->
  <header class="header">
    <div class="header-content">
      <h1>📖Class Blog</h1>
      <p>แชร์เรื่องราวในห้อง และอื่นๆ</p>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container">
    <section class="section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h2 style="margin: 0;">Class Blog Posts</h2>
        <button class="btn btn-primary" id="newPostBtn">
          <i class="fas fa-plus"></i> New Post
        </button>
      </div>

      <div style="margin-bottom: 1rem;">
        <a href="index.html" class="btn btn-outline">
          <i class="fas fa-arrow-left"></i> Back to Home
        </a>
      </div>

      <div class="search-controls">
        <input type="text" id="blogSearch" class="search-input" placeholder="Search posts...">
        <button class="btn btn-primary" id="searchBtn">
          <i class="fas fa-search"></i> Search
        </button>
        <button class="btn btn-outline" id="resetSearchBtn" style="display: none;">
          <i class="fas fa-undo"></i> Reset
        </button>
      </div>

      <div id="blogContainer">
        <div class="loading">
          <div class="loading-spinner"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- New Post Modal -->
  <div class="modal" id="postModal">
    <div class="modal-content">
      <button class="modal-close" id="closeModal">&times;</button>
      <h2 class="modal-title">Create New Post</h2>
      
      <div class="form-group">
        <label for="postTitle" class="form-label">Title</label>
        <input type="text" id="postTitle" class="form-input" placeholder="Post title">
      </div>
      
      <div class="form-group">
        <label for="postContent" class="form-label">Content</label>
        <textarea id="postContent" class="form-textarea" placeholder="Write your post here..."></textarea>
      </div>
      
      <div class="form-group">
        <label for="postAuthor" class="form-label">Author</label>
        <input type="text" id="postAuthor" class="form-input" placeholder="Your name" value="Anonymous">
      </div>
      
      <div class="form-group">
        <label class="form-label">Media (Optional)</label>
        <div class="file-upload" id="fileUpload">
          <i class="fas fa-cloud-upload-alt"></i>
          <p>Click to upload image (max 10MB)</p>
          <input type="file" id="mediaUpload" accept="image/*,video/*">
          <div class="file-options">
            <button type="button" class="btn btn-outline btn-sm" onclick="triggerFileInput('camera')">
              <i class="fas fa-camera"></i> Take Photo
            </button>
            <button type="button" class="btn btn-outline btn-sm" onclick="triggerFileInput('gallery')">
              <i class="fas fa-images"></i> Choose from Gallery
            </button>
          </div>
        </div>
        <div class="file-preview" id="filePreview"></div>
      </div>
      
      <div class="modal-actions">
        <button class="btn btn-outline" id="cancelPost">Cancel</button>
        <button class="btn btn-primary" id="submitPost">Post</button>
      </div>
    </div>
  </div>

  <!-- Comment Modal -->
  <div class="modal" id="commentModal" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
      <h2 class="modal-title">Enter Your Name</h2>
      <div class="form-group">
        <input type="text" id="commenterName" class="form-input" placeholder="Your name">
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" id="cancelComment">Cancel</button>
        <button class="btn btn-primary" id="submitComment">Submit</button>
      </div>
    </div>
  </div>

  <!-- Footer Section -->
  <footer class="footer" style="background-color: #333; color: #fff; padding: 1rem 0;">
    <div class="container">
      <p>&copy; 2025 Classroom 4/10. Created by Leon (ลีออง)</a>.</p>
      <p><a href="https://web.facebook.com/leon.ratthabhumin/" target="_blank" rel="noopener noreferrer" style="color: #ffffff;">Facebook</a></p>
      <p><a href="https://www.instagram.com/le0n_rm/" target="_blank" rel="noopener noreferrer" style="color: #ffffff;">Instagram</a></p>
      <p>Suankularb 14. Room Number 533</a>.</p>
    </div>
  </footer>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDPc5zKZzmre8sfAwx03x0jH3i1eVRAnec",
      authDomain: "classweb-81bbb.firebaseapp.com",
      projectId: "classweb-81bbb",
      databaseURL: "https://classweb-81bbb-default-rtdb.asia-southeast1.firebasedatabase.app/",
      storageBucket: "classweb-81bbb.firebasestorage.app",
      messagingSenderId: "488267142455",
      appId: "1:488267142455:web:f1c4f4fdbdfc097a3636b2"
    };

    // Cloudinary Configuration
    // Update these constants with your Cloudinary details
    const CLOUD_NAME = 'diipmdlrq'; // Your cloud name
    const UPLOAD_PRESET = 'classweb'; // Your upload preset name

    // Initialize Firebase
    let db;
    let isFirebaseReady = false;
    let currentUser = null;
    let selectedFile = null;

    function initFirebase() {
      try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        isFirebaseReady = true;
        console.log('Firebase initialized successfully');
        loadBlogPosts();
      } catch (error) {
        console.log('Firebase initialization failed:', error);
        loadDemoBlog();
      }
    }

    // Initialize when page loads
    window.addEventListener('load', initFirebase);

    // Elements
    const newPostBtn = document.getElementById('newPostBtn');
    const postModal = document.getElementById('postModal');
    const closeModal = document.getElementById('closeModal');
    const cancelPost = document.getElementById('cancelPost');
    const submitPost = document.getElementById('submitPost');
    const blogContainer = document.getElementById('blogContainer');
    const mediaUpload = document.getElementById('mediaUpload');
    const filePreview = document.getElementById('filePreview');
    const blogSearch = document.getElementById('blogSearch');
    const searchBtn = document.getElementById('searchBtn');
    const resetSearchBtn = document.getElementById('resetSearchBtn');
    
    let allBlogPosts = null;

    // Event Listeners
    newPostBtn.addEventListener('click', () => postModal.style.display = 'flex');
    closeModal.addEventListener('click', () => postModal.style.display = 'none');
    cancelPost.addEventListener('click', () => postModal.style.display = 'none');
    submitPost.addEventListener('click', createPost);
    mediaUpload.addEventListener('change', handleFileSelect);
    searchBtn.addEventListener('click', handleSearch);
    resetSearchBtn.addEventListener('click', resetSearch);
    blogSearch.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleSearch();
    });

    // File Upload Functions
    function triggerFileInput(mode) {
      const input = document.getElementById('mediaUpload');
      input.value = '';
      
      if (mode === 'camera') {
        input.setAttribute('capture', 'environment');
        input.setAttribute('accept', 'image/*');
      } else {
        input.removeAttribute('capture');
        input.setAttribute('accept', 'image/*,video/*');
      }
      input.click();
    }

    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      // Check file size (10MB limit)
      if (file.size > 10 * 1024 * 1024) {
        alert('File size must be less than 10MB');
        return;
      }
      
      // Check file type
      if (!file.type.match('image.*') && !file.type.match('video.*')) {
        alert('Only image and video files are allowed');
        return;
      }
      
      selectedFile = file;
      showFilePreview(file);
    }

    function showFilePreview(file) {
      const filePreview = document.getElementById('filePreview');
      filePreview.style.display = 'block';
      filePreview.innerHTML = `
        <div class="upload-preview">
          <div class="loading-spinner" style="display: none;"></div>
        </div>
      `;
      
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          filePreview.innerHTML = `
            <div class="upload-preview">
              <img src="${e.target.result}" alt="Preview">
              <div class="remove-file" onclick="removeSelectedFile()">
                <i class="fas fa-times"></i> Remove
              </div>
            </div>
          `;
        };
        reader.readAsDataURL(file);
      } else if (file.type.startsWith('video/')) {
        const videoUrl = URL.createObjectURL(file);
        filePreview.innerHTML = `
          <div class="upload-preview">
            <video controls>
              <source src="${videoUrl}" type="${file.type}">
            </video>
            <div class="remove-file" onclick="removeSelectedFile()">
              <i class="fas fa-times"></i> Remove
            </div>
          </div>
        `;
      }
    }

    function removeSelectedFile() {
      selectedFile = null;
      document.getElementById('mediaUpload').value = '';
      const filePreview = document.getElementById('filePreview');
      filePreview.style.display = 'none';
      filePreview.innerHTML = '';
    }

    // Cloudinary Upload Function
    async function uploadToCloudinary(file) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', UPLOAD_PRESET);
      formData.append('cloud_name', CLOUD_NAME);

      const response = await fetch(
        `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`,
        {
          method: 'POST',
          body: formData
        }
      );

      if (!response.ok) {
        throw new Error('Upload failed');
      }

      return await response.json();
    }

    // Create new post
    async function createPost() {
      const title = document.getElementById('postTitle').value.trim();
      const content = document.getElementById('postContent').value.trim();
      const author = document.getElementById('postAuthor').value.trim() || 'Anonymous';
      
      if (!title || !content) {
        alert('Please fill in title and content');
        return;
      }
      
      submitPost.disabled = true;
      submitPost.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Posting...';
      
      const postData = {
        title: title,
        content: content,
        author: author,
        timestamp: Date.now(),
        likes: 0,
        likedBy: {},
        comments: {}
      };
      
      if (selectedFile) {
        try {
          const uploadResult = await uploadToCloudinary(selectedFile);
          if (uploadResult.secure_url) {
            postData.mediaUrl = uploadResult.secure_url;
            postData.mediaType = selectedFile.type.startsWith('image/') ? 'image' : 'video';
          }
        } catch (error) {
          console.error('Upload failed:', error);
          alert('Failed to upload media. Please try again.');
          submitPost.disabled = false;
          submitPost.innerHTML = 'Post';
          return;
        }
      }

      savePostToDatabase(postData);
    }
    
    function savePostToDatabase(postData) {
      const newPostRef = db.ref('blogPosts').push();
      newPostRef.set(postData)
        .then(() => {
          resetPostForm();
          postModal.style.display = 'none';
          loadBlogPosts();
        })
        .catch((error) => {
          console.error('Error saving post:', error);
          alert('Failed to save post. Please try again.');
        })
        .finally(() => {
          submitPost.disabled = false;
          submitPost.innerHTML = 'Post';
        });
    }
    
    function resetPostForm() {
      document.getElementById('postTitle').value = '';
      document.getElementById('postContent').value = '';
      document.getElementById('postAuthor').value = 'Anonymous';
      removeSelectedFile();
    }

    // Load blog posts
    function loadBlogPosts() {
      blogContainer.innerHTML = `
        <div class="loading">
          <div class="loading-spinner"></div>
        </div>
      `;
      
      if (isFirebaseReady) {
        db.ref('blogPosts').orderByChild('timestamp').once('value')
          .then(snapshot => {
            const posts = snapshot.val();
            allBlogPosts = posts;
            renderBlogPosts(posts);
          })
          .catch(error => {
            console.error('Error loading blog posts:', error);
            loadDemoBlog();
          });
      } else {
        loadDemoBlog();
      }
    }
    
    function loadDemoBlog() {
      const demoPosts = {
        'post1': {
          id: 'post1',
          title: 'Our Amazing Science Fair Project',
          content: 'Today we presented our volcano project at the science fair. It was exciting to see everyone\'s reactions when our volcano erupted! We learned so much about chemical reactions.',
          author: 'Student Team A',
          timestamp: Date.now() - 86400000,
          likes: 5,
          likedBy: {},
          comments: {
            'comment1': {
              author: 'Teacher',
              content: 'Great job team! Your presentation was excellent.',
              timestamp: Date.now() - 80000000
            }
          },
          mediaUrl: 'https://via.placeholder.com/600x400?text=Science+Fair',
          mediaType: 'image'
        },
        'post2': {
          id: 'post2',
          title: 'Field Trip to the Museum',
          content: 'What an incredible day at the National Museum! We saw ancient artifacts and learned about our country\'s rich history. The Egyptian mummy exhibit was particularly fascinating.',
          author: 'Class Reporter',
          timestamp: Date.now() - 172800000,
          likes: 3,
          likedBy: {},
          comments: {},
          mediaUrl: 'https://via.placeholder.com/600x400?text=Museum+Trip',
          mediaType: 'image'
        }
      };
      
      allBlogPosts = demoPosts;
      renderBlogPosts(demoPosts);
    }
    
    function renderBlogPosts(posts) {
      blogContainer.innerHTML = '';
      
      if (!posts || Object.keys(posts).length === 0) {
        blogContainer.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-blog"></i>
            <p>No blog posts yet. Be the first to share!</p>
          </div>
        `;
        return;
      }
      
      const postsArray = Object.entries(posts)
        .sort(([,a], [,b]) => b.timestamp - a.timestamp);
      
      postsArray.forEach(([id, post]) => {
        renderPost(id, post);
      });
    }
    
    function renderPost(id, post) {
      const postElement = document.createElement('div');
      postElement.className = 'blog-post';
      postElement.dataset.id = id;
      
      const formattedDate = new Date(post.timestamp).toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      const isLiked = currentUser && post.likedBy && post.likedBy[currentUser];
      
      postElement.innerHTML = `
        <div class="blog-header">
          <div>
            <h3 class="blog-title">${post.title}</h3>
            <div class="blog-author">by ${post.author}</div>
          </div>
          <div class="blog-date">${formattedDate}</div>
        </div>
        
        <div class="blog-content">
          <p>${post.content}</p>
        </div>
        
        ${post.mediaUrl ? `
          <div class="blog-media">
            ${post.mediaType === 'image' ? 
              `<img src="${post.mediaUrl}" alt="${post.title}">` : 
              `<video controls src="${post.mediaUrl}"></video>`}
          </div>
        ` : ''}
        
        <div class="blog-actions">
          <button class="like-btn ${isLiked ? 'liked' : ''}" data-id="${id}">
            <span>👍</span>
            <span class="like-count">${post.likes || 0}</span>
          </button>
          <button class="comment-btn" data-id="${id}">
            <span>💬</span>
            <span>${post.comments ? Object.keys(post.comments).length : 0}</span>
          </button>
        </div>
        
        <div class="comments-section" id="comments-${id}">
          ${post.comments ? renderComments(post.comments) : ''}
          <div class="add-comment">
            <textarea class="comment-input" placeholder="Add a comment..." data-id="${id}"></textarea>
            <button class="comment-submit" data-id="${id}">Post</button>
          </div>
        </div>
      `;
      
      blogContainer.appendChild(postElement);
      
      postElement.querySelector('.like-btn').addEventListener('click', handleLike);
      postElement.querySelector('.comment-btn').addEventListener('click', toggleComments);
      postElement.querySelector('.comment-submit').addEventListener('click', addComment);
    }
    
    function renderComments(comments) {
      if (!comments || Object.keys(comments).length === 0) return '';
      
      const commentsArray = Object.entries(comments)
        .sort(([,a], [,b]) => a.timestamp - b.timestamp);
      
      return commentsArray.map(([id, comment]) => {
        const formattedDate = new Date(comment.timestamp).toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        return `
          <div class="comment" data-id="${id}">
            <div class="comment-author">${comment.author}</div>
            <div class="comment-date">${formattedDate}</div>
            <div class="comment-content">${comment.content}</div>
          </div>
        `;
      }).join('');
    }
    
    function handleLike(e) {
      const postId = e.currentTarget.dataset.id;
      if (!isFirebaseReady) {
        alert('Please sign in to like posts');
        return;
      }
      
      const postRef = db.ref(`blogPosts/${postId}`);
      const userId = 'user123';
      
      postRef.transaction((post) => {
        if (!post) return post;
        
        if (post.likedBy && post.likedBy[userId]) {
          post.likes--;
          post.likedBy[userId] = null;
        } else {
          post.likes = (post.likes || 0) + 1;
          if (!post.likedBy) post.likedBy = {};
          post.likedBy[userId] = true;
        }
        
        return post;
      });
      
      const likeBtn = e.currentTarget;
      const likeCount = likeBtn.querySelector('.like-count');
      
      if (likeBtn.classList.contains('liked')) {
        likeBtn.classList.remove('liked');
        likeCount.textContent = parseInt(likeCount.textContent) - 1;
      } else {
        likeBtn.classList.add('liked');
        likeCount.textContent = parseInt(likeCount.textContent) + 1;
      }
    }
    
    function toggleComments(e) {
      const postId = e.currentTarget.dataset.id;
      const commentsSection = document.getElementById(`comments-${postId}`);
      commentsSection.classList.toggle('expanded');
    }
    
    function addComment(e) {
      const postId = e.currentTarget.dataset.id;
      const commentInput = document.querySelector(`.comment-input[data-id="${postId}"]`);
      const commentText = commentInput.value.trim();
      
      if (!commentText) {
        alert('Please enter a comment');
        return;
      }

      const commentModal = document.getElementById('commentModal');
      const commenterNameInput = document.getElementById('commenterName');
      const submitCommentBtn = document.getElementById('submitComment');
      const cancelCommentBtn = document.getElementById('cancelComment');

      commentModal.style.display = 'flex';

      const handleSubmitComment = () => {
        const commenterName = commenterNameInput.value.trim() || 'Anonymous';
        
        const commentData = {
          author: commenterName,
          content: commentText,
          timestamp: Date.now()
        };

        if (isFirebaseReady) {
          const commentsRef = db.ref(`blogPosts/${postId}/comments`);
          commentsRef.push(commentData)
            .then(() => {
              commentInput.value = '';
              commentModal.style.display = 'none';
              commenterNameInput.value = '';
            })
            .catch((error) => {
              console.error('Error adding comment:', error);
              alert('Failed to add comment. Please try again.');
            });
        } else {
          alert('Please sign in to comment');
        }
      };

      const handleCancelComment = () => {
        commentModal.style.display = 'none';
        commenterNameInput.value = '';
      };

      submitCommentBtn.onclick = handleSubmitComment;
      cancelCommentBtn.onclick = handleCancelComment;

      commenterNameInput.onkeypress = (e) => {
        if (e.key === 'Enter') {
          handleSubmitComment();
        }
      };
    }
    
    function handleSearch() {
      const searchTerm = blogSearch.value.toLowerCase().trim();
      
      if (!searchTerm) {
        alert('Please enter a search term');
        return;
      }
      
      if (!allBlogPosts) {
        alert('Posts are still loading. Please try again shortly.');
        return;
      }
      
      const filteredPosts = Object.entries(allBlogPosts)
        .filter(([id, post]) => {
          const searchContent = `${post.title} ${post.content} ${post.author}`.toLowerCase();
          return searchContent.includes(searchTerm);
        })
        .reduce((acc, [id, post]) => {
          acc[id] = post;
          return acc;
        }, {});
      
      if (Object.keys(filteredPosts).length > 0) {
        renderBlogPosts(filteredPosts);
        resetSearchBtn.style.display = 'inline-flex';
      } else {
        blogContainer.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-search"></i>
            <p>No posts found matching "${searchTerm}"</p>
          </div>
        `;
        resetSearchBtn.style.display = 'inline-flex';
      }
    }
    
    function resetSearch() {
      blogSearch.value = '';
      resetSearchBtn.style.display = 'none';
      renderBlogPosts(allBlogPosts);
    }
    
    // Make functions available globally
    window.removeSelectedFile = removeSelectedFile;
    window.triggerFileInput = triggerFileInput;
  </script>
  <script>
    // Basic protection against right-click and keyboard shortcuts
    document.addEventListener('contextmenu', e => {
      if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
        e.preventDefault();
      }
    });

    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && (e.key === 'U' || e.key === 'u')) {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>